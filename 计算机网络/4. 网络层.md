# 计算机网络——网络层

## 4.1 网络层概述

网络层的主要功能就是把**分组**从源端传送到目的端，为分组交换网上的不同主机提供通信服务。网络层传输单位是数据报。

网络层的功能如下：

1. 路由选择和分组转发
2. 异构网络的互联（路由器）
3. 拥塞控制

### 4.1.1 数据交换方式

1. 各个层次的传输单元

- 应用层：报文
- 传输层：报文段
- 网络层：IP数据报，分组
- 数据链路层：帧
- 物理层：比特



2. 为什么数据交换？

![image-20210704141922566](/Users/wukui/Documents/study/fall-study-frontend/计算机网络/Untitled.assets/image-20210704141922566.png)

3. 电路交换

两部电话机只需要用一对电线就能够互相连接起来。

![image-20210701111352542](/Users/wukui/Documents/study/fall-study-frontend/计算机网络/4. 网络层.assets/image-20210701111352542.png)

N 部电话机两两相连，需 N(N – 1)/2对电线。当电话机的数量很大时，这种连接方法需要的电线对的数量与电话机数的平方成正比。

![image-20210701111422877](/Users/wukui/Documents/study/fall-study-frontend/计算机网络/4. 网络层.assets/image-20210701111422877.png)

电路交换的特点：

- 电路交换必定是面向连接的。 
- 独占资源



电路交换的三个阶段：

- 建立连接
- 通信
- 释放连接



电路交换的优点：

- 时延小
- 有序传输
- 无冲突
- 实时性强



电路交换缺点：

- 建立连接时间长
- 这导致通信线路的利用率很低。
- 灵活性差
- 无纠错能力



4. 报文交换

![image-20210704142728872](/Users/wukui/Documents/study/fall-study-frontend/计算机网络/4. 网络层.assets/image-20210704142728872.png)



5. 分组交换

![image-20210704142951632](/Users/wukui/Documents/study/fall-study-frontend/计算机网络/4. 网络层.assets/image-20210704142951632.png)

分组交换有两种方式

- 数据报方式：为网络层提供无连接服务。

  ![image-20210704145003517](/Users/wukui/Documents/study/fall-study-frontend/计算机网络/4. 网络层.assets/image-20210704145003517.png)

  - 无连接服务：不事先为分组的传输确定传输路径，每个分组独立确定传输路径，不同分组传输路径可能不同。

- 虚电路方式：为网络层提供连接服务。

  ![image-20210704145034157](/Users/wukui/Documents/study/fall-study-frontend/计算机网络/4. 网络层.assets/image-20210704145034157.png)

  - 连接服务：首先为分组的传输确定路径（建立连接），然后沿着该路径传输分组，分组传输的路径相同，传输结束后拆除连接。

- 数据报和虚电路方式比较：

![image-20210704150211888](/Users/wukui/Documents/study/fall-study-frontend/计算机网络/4. 网络层.assets/image-20210704150211888.png)



6. 三种方式比较

![image-20210704143657332](/Users/wukui/Documents/study/fall-study-frontend/计算机网络/4. 网络层.assets/image-20210704143657332.png)



## 4.2 路由算法和路由协议

1. 分类

- 静态路由算法（非自适应路由算法）：管理员手工配置路由信息
- 动态路由算法（自适应路由算法）：路由器之间彼此交换信息，按照路由算法优化出最佳路由表
  - 全局性：链路状态路由算法 OSPF，所有的路由器掌握完整的网络拓扑和链路费用信息
  - 分散性：距离向量路由算法 RIP，路由器只掌握物理相连的邻居以及链路费用



2. 分层次的路由选择协议

原因：

- 因特网的规模太大
- 很多单位不想让外界知道自己的路由选择协议，但是想接入因特网



![image-20210704151633411](/Users/wukui/Documents/study/fall-study-frontend/计算机网络/4. 网络层.assets/image-20210704151633411.png)



### 4.2.1 RIP协议与距离向量算法

![image-20210706133443936](/Users/wukui/Documents/study/fall-study-frontend/计算机网络/4. 网络层.assets/image-20210706133443936.png)

1. RIP协议和谁交换？多久交换一次？交换什么？

![image-20210706133808050](/Users/wukui/Documents/study/fall-study-frontend/计算机网络/4. 网络层.assets/image-20210706133808050.png)

2. 距离向量算法

![image-20210706134217083](/Users/wukui/Documents/study/fall-study-frontend/计算机网络/4. 网络层.assets/image-20210706134217083.png)

习题：

![image-20210706134434081](/Users/wukui/Documents/study/fall-study-frontend/计算机网络/4. 网络层.assets/image-20210706134434081.png)

![image-20210706134741753](/Users/wukui/Documents/study/fall-study-frontend/计算机网络/4. 网络层.assets/image-20210706134741753.png)

3. RIP报文格式

![image-20210706134804153](/Users/wukui/Documents/study/fall-study-frontend/计算机网络/4. 网络层.assets/image-20210706134804153.png)

4. 慢收敛：好消息传得快、坏消息传的慢



### 4.2.2 OSPF协议与链路状态算法

![image-20210706135531936](/Users/wukui/Documents/study/fall-study-frontend/计算机网络/4. 网络层.assets/image-20210706135531936.png)

1. 链路状态路由算法

![image-20210706135759673](/Users/wukui/Documents/study/fall-study-frontend/计算机网络/4. 网络层.assets/image-20210706135759673.png)

2. OSPF区域

![image-20210706135857025](/Users/wukui/Documents/study/fall-study-frontend/计算机网络/4. 网络层.assets/image-20210706135857025.png)

3. OSPF分组

![image-20210706140033301](/Users/wukui/Documents/study/fall-study-frontend/计算机网络/4. 网络层.assets/image-20210706140033301.png)

### 4.2.3 BGP协议

![image-20210706140330232](/Users/wukui/Documents/study/fall-study-frontend/计算机网络/4. 网络层.assets/image-20210706140330232.png)

1. BGP协议报文格式

![image-20210706140545722](/Users/wukui/Documents/study/fall-study-frontend/计算机网络/4. 网络层.assets/image-20210706140545722.png)

### 4.2.4 三种路由选择协议比较

![image-20210706140756710](/Users/wukui/Documents/study/fall-study-frontend/计算机网络/4. 网络层.assets/image-20210706140756710.png)





## 4.3 IP协议

![image-20210704151831670](/Users/wukui/Documents/study/fall-study-frontend/计算机网络/4. 网络层.assets/image-20210704151831670.png)

### 4.3.1 IP数据报格式

![image-20210704151955350](/Users/wukui/Documents/study/fall-study-frontend/计算机网络/4. 网络层.assets/image-20210704151955350.png)

![image-20210704152031815](/Users/wukui/Documents/study/fall-study-frontend/计算机网络/4. 网络层.assets/image-20210704152031815.png)

- 版本：IPv4、IPv6
- 首部长度：单位是4B，最小是5
- 区分服务：期望获得哪种服务
- 总长度：首部+数据，单位是1B
- 标识、标志、片偏移：IP数据包分片
- 生存时间（TTL）：IP分组保质期，经过路由器-1，变成0则丢弃
- 协议：数据部分的协议。
  - TCP：6
  - UDP：17
- 首部检验和：只检验首部
- 源地址
- 目的地址
- 可选部分：一般不选



### 4.3.2 IP数据报分片

1. 最大传输单元MTU

![image-20210704153741190](/Users/wukui/Documents/study/fall-study-frontend/计算机网络/4. 网络层.assets/image-20210704153741190.png)

2. IP数据报

![image-20210704154142118](/Users/wukui/Documents/study/fall-study-frontend/计算机网络/4. 网络层.assets/image-20210704154142118.png)

- 总长度的单位是1B
- 片偏移的单位是8B
- 首部的长度单位是4B

口诀：一（总长度）种八片（片偏移）的首饰（首部长度）

例题：

![image-20210704155250399](/Users/wukui/Documents/study/fall-study-frontend/计算机网络/4. 网络层.assets/image-20210704155250399.png)



### 4.3.2 IPv4地址

IP地址的历史阶段

- 分类的IP地址
- 子网的划分
- 构成超网（无分类编址方式）



1. 分类的IP地址

![image-20210704162105440](/Users/wukui/Documents/study/fall-study-frontend/计算机网络/4. 网络层.assets/image-20210704162105440.png)



- 三个局域网（橘黄色），同一个局域网的IP地址的网络号相同
  - LAN1:222.1.3.0
  - LAN2:222.1.1.0
  - LAN3:222.1.2.0
- 三个路由器，路由器的每个接口都对应了一个IP地址

![image-20210704162732514](/Users/wukui/Documents/study/fall-study-frontend/计算机网络/4. 网络层.assets/image-20210704162732514.png)



分类的IP地址

![image-20210704163737267](/Users/wukui/Documents/study/fall-study-frontend/计算机网络/4. 网络层.assets/image-20210704163737267.png)

特殊的IP地址

![image-20210704163146099](/Users/wukui/Documents/study/fall-study-frontend/计算机网络/4. 网络层.assets/image-20210704163146099.png)

私有IP地址

![image-20210704163538930](/Users/wukui/Documents/study/fall-study-frontend/计算机网络/4. 网络层.assets/image-20210704163538930.png)



### 4.3.3 网络地址转换NAT

![image-20210704164504682](/Users/wukui/Documents/study/fall-study-frontend/计算机网络/4. 网络层.assets/image-20210704164504682.png)



### 4.3.4 子网划分和子网掩码

分类的IP地址的弱点：

- IP地址空间的利用率低



1. 子网划分

![image-20210704165215824](/Users/wukui/Documents/study/fall-study-frontend/计算机网络/4. 网络层.assets/image-20210704165215824.png)

![image-20210704165536896](/Users/wukui/Documents/study/fall-study-frontend/计算机网络/4. 网络层.assets/image-20210704165536896.png)





2. 子网掩码

![image-20210704170151015](/Users/wukui/Documents/study/fall-study-frontend/计算机网络/4. 网络层.assets/image-20210704170151015.png)



3. 使用子网时分组的转发

![image-20210705152712029](/Users/wukui/Documents/study/fall-study-frontend/计算机网络/4. 网络层.assets/image-20210705152712029.png)

### 4.3.5 无分类编址 CIDR

![image-20210705153420120](/Users/wukui/Documents/study/fall-study-frontend/计算机网络/4. 网络层.assets/image-20210705153420120.png)

1. 构成超网

![image-20210705153837287](/Users/wukui/Documents/study/fall-study-frontend/计算机网络/4. 网络层.assets/image-20210705153837287.png)

2. 最长前缀匹配

使用CIDR时，查找路由表可能得到几个匹配结果，应该选择具有最长网络前缀的路由。前缀越长，地址块越小，路由越具体。

![image-20210705154132750](/Users/wukui/Documents/study/fall-study-frontend/计算机网络/4. 网络层.assets/image-20210705154132750.png)

习题：

![image-20210705154316061](/Users/wukui/Documents/study/fall-study-frontend/计算机网络/4. 网络层.assets/image-20210705154316061.png)

IP地址192.168.5.0/24：网络号是前24位

子网掩码255.255.255.248：248 => 11111000，子网号是25～29位，主机号是后三位

因此，答案是A



### 4.3.6 ARP协议

1. 发送数据的过程

![image-20210705155102639](/Users/wukui/Documents/study/fall-study-frontend/计算机网络/4. 网络层.assets/image-20210705155102639.png)

情况一：属于同一个局域网

- 报文进行划分形成报文段
- 报文段添加上IP地址形成分组
- 分组添加MAC地址形成帧
  - 若不知道目的IP地址的MAC地址，则会发送一个广播信息，传输到该局域网的所有IP地址
  - 若目的IP地址存在于该局域网，则会返回自己的MAC地址给源IP地址
  - 源目标IP地址接收到目标IP地址的MAC地址
- 帧转换成比特流进行传输



情况二：不属于同一个局域网

![image-20210705155910673](/Users/wukui/Documents/study/fall-study-frontend/计算机网络/4. 网络层.assets/image-20210705155910673.png)

- 报文进行划分形成报文段
- 报文段添加上IP地址形成分组
- 分组添加MAC地址形成帧
  - 源IP地址和目的IP地址相与发现不是一个网段，则询问自己的默认网关的MAC地址
- 帧转换成比特流进行传输



2. ARP协议

![image-20210705160414303](/Users/wukui/Documents/study/fall-study-frontend/计算机网络/4. 网络层.assets/image-20210705160414303.png)



### 4.3.7 DHCP协议

1. 主机如何获取IP地址？

- 静态配置
  - IP地址
  - 子网掩码
  - 默认网关
- 动态配置



2. DHCP协议

![image-20210705161130323](/Users/wukui/Documents/study/fall-study-frontend/计算机网络/4. 网络层.assets/image-20210705161130323.png)



### 4.3.8 ICMP协议

![image-20210705161340366](/Users/wukui/Documents/study/fall-study-frontend/计算机网络/4. 网络层.assets/image-20210705161340366.png)

1. ICMP差错报告报文（5种）

![image-20210705161528530](/Users/wukui/Documents/study/fall-study-frontend/计算机网络/4. 网络层.assets/image-20210705161528530.png)

2. ICMP差错报告报文数据字段

![image-20210705161615916](/Users/wukui/Documents/study/fall-study-frontend/计算机网络/4. 网络层.assets/image-20210705161615916.png)



3. 不发送ICMP差错报告报文的情况

![image-20210705161720289](/Users/wukui/Documents/study/fall-study-frontend/计算机网络/4. 网络层.assets/image-20210705161720289.png)



4. ICMP询问报文

![image-20210705161813398](/Users/wukui/Documents/study/fall-study-frontend/计算机网络/4. 网络层.assets/image-20210705161813398.png)



5. ICMP的应用

![image-20210705161829549](/Users/wukui/Documents/study/fall-study-frontend/计算机网络/4. 网络层.assets/image-20210705161829549.png)





## 4.4 IPv6

- 解决32位IPv4地址空间分配殆尽的问题
- 改进首部格式



1. IPv6数据格式

![image-20210705162116946](/Users/wukui/Documents/study/fall-study-frontend/计算机网络/4. 网络层.assets/image-20210705162116946.png)

![image-20210705162449302](/Users/wukui/Documents/study/fall-study-frontend/计算机网络/4. 网络层.assets/image-20210705162449302.png)





2. IPv6和IPv4

![image-20210705162726813](/Users/wukui/Documents/study/fall-study-frontend/计算机网络/4. 网络层.assets/image-20210705162726813.png)



3. IPv6地址的表示形式

![image-20210705162850924](/Users/wukui/Documents/study/fall-study-frontend/计算机网络/4. 网络层.assets/image-20210705162850924.png)



4. IPv6基本地址类型

- 单播：一对一通信，可以做源地址和目的地址
- 多播：一对多通信，可以做目的地址
- 任播：一对多钟的一个通信，可以做目的地址



5. IPv4向IPv6过度的策略

![image-20210705163122275](/Users/wukui/Documents/study/fall-study-frontend/计算机网络/4. 网络层.assets/image-20210705163122275.png)



## 4.5 IP数据报的传输方式

![image-20210706141148190](/Users/wukui/Documents/study/fall-study-frontend/计算机网络/4. 网络层.assets/image-20210706141148190.png)

1. IP组播地址

![image-20210706142016541](/Users/wukui/Documents/study/fall-study-frontend/计算机网络/4. 网络层.assets/image-20210706142016541.png)



## 4.6 移动IP

1. 相关术语

![image-20210706142410799](/Users/wukui/Documents/study/fall-study-frontend/计算机网络/4. 网络层.assets/image-20210706142410799.png)



2. 移动IP通信过程

![image-20210706142703278](/Users/wukui/Documents/study/fall-study-frontend/计算机网络/4. 网络层.assets/image-20210706142703278.png)

![image-20210706142804444](/Users/wukui/Documents/study/fall-study-frontend/计算机网络/4. 网络层.assets/image-20210706142804444.png)



## 4.7 网络层设备

1. 路由器

![image-20210706142933542](/Users/wukui/Documents/study/fall-study-frontend/计算机网络/4. 网络层.assets/image-20210706142933542.png)



2. 输入端口对线路上收到的分组的处理

![image-20210706143124207](/Users/wukui/Documents/study/fall-study-frontend/计算机网络/4. 网络层.assets/image-20210706143124207.png)

3. 输出端口将交换结构传送来的分组发送到的线路

![image-20210706143228220](/Users/wukui/Documents/study/fall-study-frontend/计算机网络/4. 网络层.assets/image-20210706143228220.png)



4. 三层设备的区别

![image-20210706143313150](/Users/wukui/Documents/study/fall-study-frontend/计算机网络/4. 网络层.assets/image-20210706143313150.png)

5. 路由表和路由转发

![image-20210706143518367](/Users/wukui/Documents/study/fall-study-frontend/计算机网络/4. 网络层.assets/image-20210706143518367.png)









