# 计算机网络——数据链路层

## 3.1 数据链路层功能概述

1. 一些概念

- 结点：主机和路由器
- 链路：网络中两个节点之间的**物理通道**，链路的传输媒介有双绞线、光纤和微波。分为有线链路和无线链路。
- 数据链路：网络中两个节点之间的**逻辑通道**，把实现控制数据传输协议的硬件和软件加到链路上就构成数据链路。
- 帧：链路层的协议数据单元，封装网络层数据报



2. 数据链路层的功能

数据链路层负责通过一条数据链路从一个结点向另一个物理链路直接相连的相邻结点传送数据报

![image-20210702173638413](/Users/wukui/Documents/study/fall-study-frontend/计算机网络/3. 数据链路层.assets/image-20210702173638413.png)

- 功能一：为网络层提供服务。无确认无连接服务，又确认无连接服务，又确认面向连接服务。
- 功能二：链路管理，即连接的建立、维持、释放（用于面向连接服务）
- 功能三：组帧
- 功能四：流量控制
- 功能五：差错控制



## 3.2 封装成帧和透明传输

1. 封装成帧

就是在一段数据的前后添加首部和尾部。接收端在收到物理层上交的比特流后，就能根据首部和尾部的标记，从收到的比特流中识别帧的开始和结束。

![image-20210702174238293](/Users/wukui/Documents/study/fall-study-frontend/计算机网络/3. 数据链路层.assets/image-20210702174238293.png)

![image-20210702174608607](/Users/wukui/Documents/study/fall-study-frontend/计算机网络/3. 数据链路层.assets/image-20210702174608607.png)

2. 透明传输

透明传输是指不管传输的数据是什么样的比特组合，都应该能在链路上传送。当所传的数据中的比特组合恰好与某一控制信息是一样的时候，就必须采取适当的措施，使接收方不会将这样的数据误认为是某种控制信息。



- 字符计数法

![image-20210702175340843](/Users/wukui/Documents/study/fall-study-frontend/计算机网络/3. 数据链路层.assets/image-20210702175340843.png)

- 字符填充法

![image-20210702175518875](/Users/wukui/Documents/study/fall-study-frontend/计算机网络/3. 数据链路层.assets/image-20210702175518875.png)

![image-20210702175705747](/Users/wukui/Documents/study/fall-study-frontend/计算机网络/3. 数据链路层.assets/image-20210702175705747.png)

- 零比特填充法

![image-20210702175835328](/Users/wukui/Documents/study/fall-study-frontend/计算机网络/3. 数据链路层.assets/image-20210702175835328.png)

- 违规编码法

![image-20210702180045157](/Users/wukui/Documents/study/fall-study-frontend/计算机网络/3. 数据链路层.assets/image-20210702180045157.png)

因为**字节计数法**的count字段脆弱，有差值会造成毁灭性的后果。**字符填充法**的是线上会有复杂性和不兼容性，目前比较普遍使用的是**比特填充**和**违规编码法**。

## 3.3 差错控制

1. 差错怎么来的？

![image-20210702184711060](/Users/wukui/Documents/study/fall-study-frontend/计算机网络/3. 数据链路层.assets/image-20210702184711060.png)

2. 差错控制（比特错）的方法

（1）检错编码

- 奇偶校验码

![image-20210702185741377](/Users/wukui/Documents/study/fall-study-frontend/计算机网络/3. 数据链路层.assets/image-20210702185741377.png)

- 循环冗余码CRC

![image-20210702190304222](/Users/wukui/Documents/study/fall-study-frontend/计算机网络/3. 数据链路层.assets/image-20210702190304222.png)

![image-20210702190426940](/Users/wukui/Documents/study/fall-study-frontend/计算机网络/3. 数据链路层.assets/image-20210702190426940.png)

（2）纠错编码

- 海明码：发现双比特错，纠正单比特错



## 3.4 流量控制和可靠传输机制

1. 较高的发送速度和较低的接受能力不匹配，会造成传输的错误，因此流量控制也是数据链路层的一项重要工作。

- 数据链路层的流量控制是点对点的，而传输层的流量控制是端到端的。
- 数据链路层流量控制手段：接受方收不下就不回复确认
- 传输层流量控制手段：接收端给发送端一个窗口公告



2. 流量控制的方法：

- 停止-等待协议

- 滑动窗口协议
  - 后退N帧协议（GBN）
  - 选择重传协议（SR）

![image-20210702200423987](/Users/wukui/Documents/study/fall-study-frontend/计算机网络/3. 数据链路层.assets/image-20210702200423987.png)



3. 可靠传输、滑动窗口、流量控制

![image-20210702200927370](/Users/wukui/Documents/study/fall-study-frontend/计算机网络/3. 数据链路层.assets/image-20210702200927370.png)

### 3.4.1 停止等待协议

![image-20210702201327644](/Users/wukui/Documents/study/fall-study-frontend/计算机网络/3. 数据链路层.assets/image-20210702201327644.png)

1. 无差错的情况下

![image-20210702201627761](/Users/wukui/Documents/study/fall-study-frontend/计算机网络/3. 数据链路层.assets/image-20210702201627761.png)

2. 有差错的情况下

- 数据帧丢失或检测到帧出错

![image-20210702202108844](/Users/wukui/Documents/study/fall-study-frontend/计算机网络/3. 数据链路层.assets/image-20210702202108844.png)

- ACK丢失

![image-20210702203733186](/Users/wukui/Documents/study/fall-study-frontend/计算机网络/3. 数据链路层.assets/image-20210702203733186.png)

- ACK迟到

![image-20210702203907442](/Users/wukui/Documents/study/fall-study-frontend/计算机网络/3. 数据链路层.assets/image-20210702203907442.png)

3. 性能分析

信道利用率太低



4. 信道利用率

![image-20210702204213951](/Users/wukui/Documents/study/fall-study-frontend/计算机网络/3. 数据链路层.assets/image-20210702204213951.png)

### 3.4.2 流水线

rdt3.0是一个功能正确的传输协议，但是他的**停等协议**（等待接收方返回的ACK后才能进入等待上层调用的状态）的特殊性能也造成了效率较低的问题。

解决办法：不以停等的方式运行，允许发送方发送多个分组，无需等待确认。这种技术称为**流水线**。
![在这里插入图片描述](https://img-blog.csdnimg.cn/20210322152617289.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80Mzk1MDE0Mg==,size_16,color_FFFFFF,t_70)

流水线带来的影响：

- 必须增加序号范围，因为每个分组必须有唯一的标识符
- 协议的发送发和接收方必须缓存多个分组
- 所需序号范围对缓冲的要求取决于数据传输协议如何处理丢失、损坏以及延时过大的分组。解决流水线差错恢复的两种基本方法是：**回退N步**（GBN）和**选择重传**（SR）

### 3.4.3 回退N步协议（GBN）

1. 回退N步协议（GBN协议，滑动窗口协议）：允许发送发发送多个分组不需要等待确认，但是未确认的分组数不能超过某个最大值N。接收方窗口为1。

2. 设置N的原因：流量控制、拥塞控制

若采用k个比特对帧编号，那么发送窗口的n应该满足 1<= n <= 2^k - 1。因为窗口尺寸过大会使得接收方无法区别新帧和旧帧。

3. GBN协议响应的事件：

- 发送方：
  - 当上层调用时
    - 窗口已满，告诉发送方等待一会
    - 窗口未满，产生一个分组并传送
  - 收到一个ACK
    - 窗口向右滑动
    - GBN协议中，对n号帧采用累计确认的方式，也就是收到了n号帧表示n号帧之前的所有帧都被接受到了。
  - 超时事件
    - 回退N帧的含义就是，当出现丢失和时延较长的帧的情况时，定时器会重新发送所有已发送但未被确认的帧。
- 接收方：
  - 序号为n的分组被正确接收到，并且按序，为n发一个ACK
  - 其它所有情况，接收方丢弃该分组，并选择最近序列的分组重新发ACK

![image-20210703131104462](/Users/wukui/Documents/study/fall-study-frontend/计算机网络/3. 数据链路层.assets/image-20210703131104462.png)

例子：

![image-20210703132015619](/Users/wukui/Documents/study/fall-study-frontend/计算机网络/3. 数据链路层.assets/image-20210703132015619.png)

### 3.4.4 选择重传协议（SR）

1. GBN协议的问题：

   滑动窗口协议潜为了保证分组的正确顺序，对数据进行重传，但是考虑到窗口长度和带宽较大的情况，就会造成重复传递带来的效率问题。



2. 选择重传响应的事件

- 发送方：
  - 当上层调用时
    - 窗口已满，告诉发送方等待一会
    - 窗口未满，产生一个分组并传送
  - 收到一个ACK
    - 如果收到的窗口最小序号，窗口向右滑动到下一个未被确认的帧。
    - 其他情况对接收到的帧进行缓存。
  - 超时事件
    - 当每个帧都有自己的定时器，当超时时重传一个帧。
- 接收方：
  - 接到一个帧不管序号如何都进行缓存，并返回一个确认帧，直到滑动窗口内的所有帧都被接受才将一批帧交付给上层，再进行窗口滑动。



![image-20210703132957422](/Users/wukui/Documents/study/fall-study-frontend/计算机网络/3. 数据链路层.assets/image-20210703132957422.png)

例子：

![image-20210703134003376](/Users/wukui/Documents/study/fall-study-frontend/计算机网络/3. 数据链路层.assets/image-20210703134003376.png)



## 3.5 介质访问控制

1. 传输数据使用的两种链路

- 点对点链路
  - 两个相邻结点通过一条链路相连，没有第三者
  - 应用：PPP协议，常用于广域网
- 广播式链路
  - 所有主机共享介质
  - 应用：早起的以太网、无线局域网，常用于局域网
  - 经典拓扑结构：总线型、星型



2. 介质访问控制

采取一定的措施，使得两对结点之间的通信不会出现互相干扰的情况

![image-20210703135541196](/Users/wukui/Documents/study/fall-study-frontend/计算机网络/3. 数据链路层.assets/image-20210703135541196.png)

对比：

![image-20210703143039348](/Users/wukui/Documents/study/fall-study-frontend/计算机网络/3. 数据链路层.assets/image-20210703143039348.png)

### 3.5.1 信道划分介质访问控制

信道划分介质访问控制：将使用介质的每个设备与来自同一信道上的其他设备的通信隔离，把时域和频域资源合理的分配给网络上的设备

![image-20210703140016026](/Users/wukui/Documents/study/fall-study-frontend/计算机网络/3. 数据链路层.assets/image-20210703140016026.png)

- 频分复用 FDM：所有用户在同样的时间占用不同的带宽资源。

![image-20210703140211723](/Users/wukui/Documents/study/fall-study-frontend/计算机网络/3. 数据链路层.assets/image-20210703140211723.png)

- 时分复用 TDM：所有用户在不同的时间占用同样的频带宽度。 

![image-20210703140344937](/Users/wukui/Documents/study/fall-study-frontend/计算机网络/3. 数据链路层.assets/image-20210703140344937.png)

STDM是改进的时分复用，他可以动态的分配时隙

- 波分复用 WDM：就是光的频分复用。

![image-20210703140638294](/Users/wukui/Documents/study/fall-study-frontend/计算机网络/3. 数据链路层.assets/image-20210703140638294.png)

- 码分复用 CDM：在同一时间同一频率根据传输的数据码进行区分

### 3.5.2 随机访问介质访问控制

- ALOHA协议

  - 纯ALOHA协议

  ![image-20210703141544948](/Users/wukui/Documents/study/fall-study-frontend/计算机网络/3. 数据链路层.assets/image-20210703141544948.png)

  - 时隙ALOHA协议

  ![image-20210703141755696](/Users/wukui/Documents/study/fall-study-frontend/计算机网络/3. 数据链路层.assets/image-20210703141755696.png)

  - 信息传输的效率低

- CSMA协议（载波监听多路访问协议）

  ![image-20210703142039762](/Users/wukui/Documents/study/fall-study-frontend/计算机网络/3. 数据链路层.assets/image-20210703142039762.png)

  - 1-坚持CSMA

  ![image-20210703142311297](/Users/wukui/Documents/study/fall-study-frontend/计算机网络/3. 数据链路层.assets/image-20210703142311297.png)

  - 非坚持CSMA

  ![image-20210703142328133](/Users/wukui/Documents/study/fall-study-frontend/计算机网络/3. 数据链路层.assets/image-20210703142328133.png)

  - p-坚持CSMA

    ![image-20210703142537117](/Users/wukui/Documents/study/fall-study-frontend/计算机网络/3. 数据链路层.assets/image-20210703142537117.png)

  - 比较

  ![image-20210703142559550](/Users/wukui/Documents/study/fall-study-frontend/计算机网络/3. 数据链路层.assets/image-20210703142559550.png)

- CSMA/CD协议（载波监听多点接入/碰撞协议）

  ![image-20210703173538775](/Users/wukui/Documents/study/fall-study-frontend/计算机网络/3. 数据链路层.assets/image-20210703173538775.png)

  - 传播时延对载波监听的影响：电磁波的传输需要时间，会造成冲突

  ![image-20210703173833468](/Users/wukui/Documents/study/fall-study-frontend/计算机网络/3. 数据链路层.assets/image-20210703173833468.png)

  - 重传机制

  ![image-20210703174218973](/Users/wukui/Documents/study/fall-study-frontend/计算机网络/3. 数据链路层.assets/image-20210703174218973.png)

  - 最小帧长，以太网的最短帧长是64B

  ![image-20210703174409353](/Users/wukui/Documents/study/fall-study-frontend/计算机网络/3. 数据链路层.assets/image-20210703174409353.png)

  

  

- CSMA/CA协议（载波监听多点接入/碰撞避免协议）

  - 工作原理

    ![image-20210703144623282](/Users/wukui/Documents/study/fall-study-frontend/计算机网络/3. 数据链路层.assets/image-20210703144623282.png)

  - 对比CSMA/CD

    ![image-20210703144652915](/Users/wukui/Documents/study/fall-study-frontend/计算机网络/3. 数据链路层.assets/image-20210703144652915.png)

### 3.5.3 轮询介质访问控制

- 轮询协议

![image-20210703143311752](/Users/wukui/Documents/study/fall-study-frontend/计算机网络/3. 数据链路层.assets/image-20210703143311752.png)

- 令牌传递协议

![image-20210703143656102](/Users/wukui/Documents/study/fall-study-frontend/计算机网络/3. 数据链路层.assets/image-20210703143656102.png)

## 3.6 局域网

![image-20210703165526446](/Users/wukui/Documents/study/fall-study-frontend/计算机网络/3. 数据链路层.assets/image-20210703165526446.png)

1. 网络拓扑

总线型较好，现在普遍使用

![image-20210703165730967](/Users/wukui/Documents/study/fall-study-frontend/计算机网络/3. 数据链路层.assets/image-20210703165730967.png)

2. 传输介质

![image-20210703165824979](/Users/wukui/Documents/study/fall-study-frontend/计算机网络/3. 数据链路层.assets/image-20210703165824979.png)

3. 介质访问控制方法

![image-20210703170007959](/Users/wukui/Documents/study/fall-study-frontend/计算机网络/3. 数据链路层.assets/image-20210703170007959.png)

4. 局域网的分类

![image-20210703170135251](/Users/wukui/Documents/study/fall-study-frontend/计算机网络/3. 数据链路层.assets/image-20210703170135251.png)

5. IEEE 802系列标准

EEE 802又称为LMSC（LAN /MAN Standards Committee， 局域网/[城域网](https://baike.baidu.com/item/城域网)标准委员会），致力于研究局域网和城域网的[物理层](https://baike.baidu.com/item/物理层/4329158)和[MAC](https://baike.baidu.com/item/MAC)层中定义的服务和协议，对应[OSI](https://baike.baidu.com/item/OSI)网络参考模型的最低两层（即物理层和[数据链路层](https://baike.baidu.com/item/数据链路层/4329290)）。

![image-20210703170428287](/Users/wukui/Documents/study/fall-study-frontend/计算机网络/3. 数据链路层.assets/image-20210703170428287.png)

6. MAC子层和LLC子层

![image-20210703170556369](/Users/wukui/Documents/study/fall-study-frontend/计算机网络/3. 数据链路层.assets/image-20210703170556369.png)

### 3.6.1 以太网

![image-20210703170835355](/Users/wukui/Documents/study/fall-study-frontend/计算机网络/3. 数据链路层.assets/image-20210703170835355.png)

1. 以太网提供无连接、不可靠服务

- 无连接：发送方和接收方之间无握手
- 不可靠：不对发送方的数据帧编号，接收方不向发送方确认，差错帧直接丢弃，差错纠正由高层次负责



2. 以太网传输介质与拓扑结构的发展

![image-20210703171209353](/Users/wukui/Documents/study/fall-study-frontend/计算机网络/3. 数据链路层.assets/image-20210703171209353.png)

3. 10BASE-T以太网

![image-20210703171323637](/Users/wukui/Documents/study/fall-study-frontend/计算机网络/3. 数据链路层.assets/image-20210703171323637.png)

4. 适配器和MAC地址

![image-20210703171452411](/Users/wukui/Documents/study/fall-study-frontend/计算机网络/3. 数据链路层.assets/image-20210703171452411.png)

5. 以太网的MAC帧

![image-20210703172009754](/Users/wukui/Documents/study/fall-study-frontend/计算机网络/3. 数据链路层.assets/image-20210703172009754.png)

6. 高速以太网

![image-20210703172116280](/Users/wukui/Documents/study/fall-study-frontend/计算机网络/3. 数据链路层.assets/image-20210703172116280.png)



### 3.6.2 无线局域网

IEEE802.11 是无线局域网的通用标准，它是由IEEE所定义的无线网络通信的标准

![image-20210703172334108](/Users/wukui/Documents/study/fall-study-frontend/计算机网络/3. 数据链路层.assets/image-20210703172334108.png)

1. 802.11的MAC帧头格式

![image-20210703172658954](/Users/wukui/Documents/study/fall-study-frontend/计算机网络/3. 数据链路层.assets/image-20210703172658954.png)

![image-20210703172715085](/Users/wukui/Documents/study/fall-study-frontend/计算机网络/3. 数据链路层.assets/image-20210703172715085.png)

2. 无线局域网分类

- 有固定基础设施无线局域网

![image-20210703173030127](/Users/wukui/Documents/study/fall-study-frontend/计算机网络/3. 数据链路层.assets/image-20210703173030127.png)

- 无固定基础设施无线局域网的自组织网络

![image-20210703173058012](/Users/wukui/Documents/study/fall-study-frontend/计算机网络/3. 数据链路层.assets/image-20210703173058012.png)

## 3.7 广域网

![image-20210703174640169](/Users/wukui/Documents/study/fall-study-frontend/计算机网络/3. 数据链路层.assets/image-20210703174640169.png)



### 3.7.1 PPP协议

点对点协议PPP（Point-to-Point Protocol）是目前使用最广泛的数据链路层协议，用户使用拨号电话接入因特网时一般都使用PPP协议

1. 特点：只支持全双工链路



2. 满足的要求：

- 简单：无需纠错，无需序号，无需流量控制
- 封装成帧
- 透明传输
  - 异步线路：字节填充
  - 同步线路：比特填充
- 多种网络层协议：封装的IP数据报可以采用多种协议
- 多种类型链路：串行/并行，同步/异步，电/光
- 差错检查：错就丢弃
- 检测连接状态：链路是否正常工作
- 最大传送单元：数据部分最大长度MTU
- 网络层地址协商：通信双方必须知道彼此地址
- 数据压缩协商



3. 无需满足的要求

- 纠错
- 流量控制
- 序号
- 不支持多点线路



4. PPP协议组成的三个部分

![image-20210703175829559](/Users/wukui/Documents/study/fall-study-frontend/计算机网络/3. 数据链路层.assets/image-20210703175829559.png)



5. PPP协议的状态图

![image-20210703175846188](/Users/wukui/Documents/study/fall-study-frontend/计算机网络/3. 数据链路层.assets/image-20210703175846188.png)

6. PPP协议帧格式

![image-20210703180027401](/Users/wukui/Documents/study/fall-study-frontend/计算机网络/3. 数据链路层.assets/image-20210703180027401.png)

### 3.7.2 HDLC协议

![image-20210703180155734](/Users/wukui/Documents/study/fall-study-frontend/计算机网络/3. 数据链路层.assets/image-20210703180155734.png)

1. HDLC的站

![image-20210703180244357](/Users/wukui/Documents/study/fall-study-frontend/计算机网络/3. 数据链路层.assets/image-20210703180244357.png)

2. HDLC的帧格式

![image-20210703180343067](/Users/wukui/Documents/study/fall-study-frontend/计算机网络/3. 数据链路层.assets/image-20210703180343067.png)

### 3.7.3 PPP和HDLC对比

![image-20210703180438747](/Users/wukui/Documents/study/fall-study-frontend/计算机网络/3. 数据链路层.assets/image-20210703180438747.png)



## 3.8 链路层的设备

![image-20210703181037699](/Users/wukui/Documents/study/fall-study-frontend/计算机网络/3. 数据链路层.assets/image-20210703181037699.png)

1. 网桥的分类

- 透明网桥

![image-20210703181312566](/Users/wukui/Documents/study/fall-study-frontend/计算机网络/3. 数据链路层.assets/image-20210703181312566.png)

- 源路由网桥

![image-20210703181644996](/Users/wukui/Documents/study/fall-study-frontend/计算机网络/3. 数据链路层.assets/image-20210703181644996.png)



2. 多接口网桥——以太网交换机

![image-20210703181932572](/Users/wukui/Documents/study/fall-study-frontend/计算机网络/3. 数据链路层.assets/image-20210703181932572.png)

3. 冲突域和广播域

![image-20210703182003549](/Users/wukui/Documents/study/fall-study-frontend/计算机网络/3. 数据链路层.assets/image-20210703182003549.png)

![image-20210703182135993](/Users/wukui/Documents/study/fall-study-frontend/计算机网络/3. 数据链路层.assets/image-20210703182135993.png)

